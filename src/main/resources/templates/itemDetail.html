<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${book.name}">도서 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.portone.io/v2/browser-sdk.js" defer></script>
</head>
<body class="container mt-5">

<!--상단 네비게이션-->
<div th:replace="fragments/homeHeader :: homeHeader"></div>

<!-- 이미지 표시 -->
<div class="text-center mb-4">
    <!-- 이미지 파일명이 존재하면 해당 파일 출력, 없으면 기본 이미지 출력 -->
    <img th:if="${book.imageName != null}" th:src="@{'/images/' + ${book.imageName}}" class="img-fluid" style="max-height: 350px;" alt="도서 이미지" />

    <img th:if="${book.imageName == null}" th:src="@{/images/default-book.jpg}" class="img-fluid" style="max-height: 350px;" alt="도서 이미지" />
</div>

<!--<form th:action="@{/order}" method="post">-->

<h2 th:text="${book.name}" class="fw-bold mb-3"></h2>
<p>저자: <span th:text="${book.author}"></span></p>
<p>ISBN: <span th:text="${book.isbn}"></span></p>
<p>가격: <span th:text="${book.price}"></span> 원</p>
<p>재고: <span th:text="${book.stockQuantity}"></span> 개</p>

    <div class="mb-3">
        <label class="form-label">주문 수량</label>
        <input type="number" name="count" class="form-control" value="1" min="1" required />
    </div>

    <!--결제 버튼-->
<button type="button" onclick="requestPay()" class="btn btn-primary">결제하기</button>
<!--<button type="submit" class="btn btn-primary">주문하기</button>-->

<!--</form>-->

<!--v2 버전 해보기-->
<script>
    // PortOne 로딩 대기
    function waitPortOneLoaded() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (window.PortOne) {
                    clearInterval(check);
                    resolve();
                }
            }, 100);
        });
    }

    // 전역에 결제 함수 등록
    window.requestPay = async function () {
        await waitPortOneLoaded();

        function randomId() {
            return [...crypto.getRandomValues(new Uint32Array(2))]
                .map((word) => word.toString(16).padStart(8, "0"))
                .join("");
        }

        const paymentId = randomId();

        const payment = await PortOne.requestPayment({
            storeId: "store-5290c2f9-b27d-4bf3-a88a-48717e658e5e", // 예: iamporttest_3
            channelKey: "channel-key-4ea5e726-aaab-43e4-a936-1ea0c68bfa69", // 예: channel-key-xxxx...
            paymentId: paymentId,
            orderName: "테스트 상품",
            totalAmount: 100,
            currency: "KRW",
            payMethod: "CARD",
            redirectUrl: "https://8e0b6d606c26.ngrok-free.app/payment/success"
        });

        if (payment.code !== undefined) {
            alert("결제 실패: " + payment.message);
            return;
        }

        alert("결제 성공: imp_uid = " + payment.imp_uid);
    };
</script>

</body>
</html>


<!--안쓰는 코드-->

<!--
    <input type="hidden" name="itemId" th:value="${book.id}" />
    <input type="hidden" name="memberId" th:value="${loginMember.id}" />
-->
<!--<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
<script src="/main.js"></script>-->
<!--
<script th:inline="javascript">
    const IMP = window.IMP;
    IMP.init("imp15254256"); // 본인의 아임포트 가맹점 식별코드로 변경할 것

    const bookId = [[${book.id}]];
    const memberId = [[${loginMember.id}]];
    const bookName = "[[${book.name}]]";
    const bookPrice = [[${book.price}]];

    function requestPay() {

        const count = document.querySelector("input[name='count']").value;
        const totalAmount = bookPrice * count;

        // 아임포트 결제창 호출
        IMP.request_pay({
            pg: "tosspayments", // 토스페이먼츠
            pay_method: "card",
            merchant_uid: "order_" + new Date().getTime(),
            name: bookName,
            amount: totalAmount,
            buyer_email: "test@user.com",
            buyer_name: "홍길동",
            buyer_tel: "01012345678",
            buyer_addr: "서울시 강남구",
            buyer_postcode: "12345"
        }, function (rsp) {
            if (rsp.success) {
                // 결제 성공시 서버에 주문 + 검증 요청
                fetch("/api/payments/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        imp_uid: rsp.imp_uid,
                        merchant_uid: rsp.merchant_uid,
                        memberId: memberId,
                        itemId: bookId,
                        count: count
                    })
                }).then(res => res.json())
                    .then(data => {
                        alert("결제 및 주문 완료: " + JSON.stringify(data));
                        window.location.href = "/orders";
                    });
            } else {
                alert("결제 실패: " + rsp.error_msg);
            }
        });
    }
</script>-->

<!--<script th:inline="javascript">
    function waitPortOneLoaded() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (window.PortOne) {
                    clearInterval(check);
                    resolve();
                }
            }, 100);
        });
    }

    window.requestPay = async function () {
        await waitPortOneLoaded();

        function randomId() {
            return [...crypto.getRandomValues(new Uint32Array(2))]
                .map((word) => word.toString(16).padStart(8, "0"))
                .join("");
        }

        const paymentId = randomId();

        const payment = await PortOne.requestPayment({
            storeId: "iamporttest_3",
            channelKey: "channel-key-4ea5e726-aaab-43e4-a936-1ea0c68bfa69",
            paymentId: paymentId,
            orderName: "[[${book.name}]]",
            totalAmount: [[${book.price}]],
            currency: "KRW",
            payMethod: "CARD",
            customData: {
                itemId: [[${book.id}]],
                memberId: [[${loginMember.id}]],
                count: document.querySelector("input[name='count']").value
            }
        });

        if (payment.code !== undefined) {
            alert("결제 실패: " + payment.message);
            return;
        }

        const response = await fetch("/api/payment/complete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId: payment.paymentId })
        });

        const result = await response.json();
        alert("결제 완료: " + JSON.stringify(result));
        location.href = "/orders";
    };
</script>-->
