<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${book.name}">ë„ì„œ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SDK ì¶”ê°€ -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body class="container mt-5">

<!--ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜-->
<div th:replace="fragments/homeHeader :: homeHeader"></div>

<!-- ì´ë¯¸ì§€ í‘œì‹œ -->
<div class="text-center mb-4">
    <!-- ì´ë¯¸ì§€ íŒŒì¼ëª…ì´ ì¡´ì¬í•˜ë©´ í•´ë‹¹ íŒŒì¼ ì¶œë ¥, ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ ì¶œë ¥ -->
    <img th:if="${book.imageName != null}" th:src="@{'/images/' + ${book.imageName}}" class="img-fluid" style="max-height: 350px;" alt="ë„ì„œ ì´ë¯¸ì§€" />

    <img th:if="${book.imageName == null}" th:src="@{/images/default-book.jpg}" class="img-fluid" style="max-height: 350px;" alt="ë„ì„œ ì´ë¯¸ì§€" />
</div>

<!--<form th:action="@{/order}" method="post">-->

<h2 th:text="${book.name}" class="fw-bold mb-3"></h2>
<p>ì €ì: <span th:text="${book.author}"></span></p>
<p>ISBN: <span th:text="${book.isbn}"></span></p>
<p>ê°€ê²©: <span th:text="${book.price}"></span> ì›</p>
<p>ì¬ê³ : <span th:text="${book.stockQuantity}"></span> ê°œ</p>

    <div class="mb-3">
        <label class="form-label">ì£¼ë¬¸ ìˆ˜ëŸ‰</label>
        <input id="payment-button" type="number" name="count" class="form-control" value="1" min="1" required />
    </div>

    <!--ê²°ì œ ë²„íŠ¼-->
<button type="button" onclick="requestPayment()()" class="btn btn-primary">ê²°ì œí•˜ê¸°</button>
<!--<button type="submit" class="btn btn-primary">ì£¼ë¬¸í•˜ê¸°</button>-->

<!--</form>-->

<script th:inline="javascript">
    const bookId = [[${book.id}]];
    const bookName = [[${book.name}]];
    const bookPrice = [[${book.price}]];
    const memberId = [[${loginMember.id}]];
</script>


<script th:inline="javascript">
    // ------  SDK ì´ˆê¸°í™” ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#í† ìŠ¤í˜ì´ë¨¼ì¸ -ì´ˆê¸°í™”
    const clientKey = "test_ck_0RnYX2w532o7od6ap7plVNeyqApQ";
    const customerKey = "-jm31h8b78N1QVEiFstgy";
    const tossPayments = TossPayments(clientKey);
    // íšŒì› ê²°ì œ
    // @docs https://docs.tosspayments.com/sdk/v2/js#tosspaymentspayment
    const payment = tossPayments.payment({ customerKey });
    // ë¹„íšŒì› ê²°ì œ
    // const payment = tossPayments.payment({customerKey: TossPayments.ANONYMOUS})

    // ------ 'ê²°ì œí•˜ê¸°' ë²„íŠ¼ ëˆ„ë¥´ë©´ ê²°ì œì°½ ë„ìš°ê¸° ------
    // @docs https://docs.tosspayments.com/sdk/v2/js#paymentrequestpayment
    async function requestPayment() {

        const count = document.querySelector("input[name='count']").value;
        const totalAmount = bookPrice * count;

        const orderId = `${memberId}-${Date.now()}`; // ê³ ìœ í•œ ì£¼ë¬¸ ID

        // ê²°ì œë¥¼ ìš”ì²­í•˜ê¸° ì „ì— orderId, amountë¥¼ ì„œë²„ì— ì €ì¥í•˜ì„¸ìš”.
        // ê²°ì œ ê³¼ì •ì—ì„œ ì•…ì˜ì ìœ¼ë¡œ ê²°ì œ ê¸ˆì•¡ì´ ë°”ë€ŒëŠ” ê²ƒì„ í™•ì¸í•˜ëŠ” ìš©ë„ì…ë‹ˆë‹¤.
        await payment.requestPayment({
            method: "CARD", // ì¹´ë“œ ê²°ì œ
            amount: {
                currency: "KRW",
                value: totalAmount,
            },
            orderId: orderId, // ê³ ìœ  ì£¼ë¬¸ë²ˆí˜¸
            orderName: bookName,
            successUrl: `${window.location.origin}/payments/view/success?` +
                `memberId=${memberId}&itemId=${bookId}&count=${count}&orderId=${orderId}&amount=${totalAmount}`,
            failUrl: `${window.location.origin}/api/payments/fail`,
            customerEmail: "customer123@gmail.com",
            customerName: "ê¹€í† ìŠ¤",
            customerMobilePhone: "01012341234",
            // ì¹´ë“œ ê²°ì œì— í•„ìš”í•œ ì •ë³´
            card: {
                useEscrow: false,
                flowMode: "DEFAULT", // í†µí•©ê²°ì œì°½ ì—¬ëŠ” ì˜µì…˜
                useCardPoint: false,
                useAppCardOnly: false,
            },
        });
    }
</script>

</body>
</html>


<!--ì•ˆì“°ëŠ” ì½”ë“œ-->

<!--
    <input type="hidden" name="itemId" th:value="${book.id}" />
    <input type="hidden" name="memberId" th:value="${loginMember.id}" />
-->
<!--<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
<script src="/main.js"></script>-->
<!--
<script th:inline="javascript">
    const IMP = window.IMP;
    IMP.init("imp15254256"); // ë³¸ì¸ì˜ ì•„ì„í¬íŠ¸ ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¡œ ë³€ê²½í•  ê²ƒ

    const bookId = [[${book.id}]];
    const memberId = [[${loginMember.id}]];
    const bookName = "[[${book.name}]]";
    const bookPrice = [[${book.price}]];

    function requestPay() {

        const count = document.querySelector("input[name='count']").value;
        const totalAmount = bookPrice * count;

        // ì•„ì„í¬íŠ¸ ê²°ì œì°½ í˜¸ì¶œ
        IMP.request_pay({
            pg: "tosspayments", // í† ìŠ¤í˜ì´ë¨¼ì¸ 
            pay_method: "card",
            merchant_uid: "order_" + new Date().getTime(),
            name: bookName,
            amount: totalAmount,
            buyer_email: "test@user.com",
            buyer_name: "í™ê¸¸ë™",
            buyer_tel: "01012345678",
            buyer_addr: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
            buyer_postcode: "12345"
        }, function (rsp) {
            if (rsp.success) {
                // ê²°ì œ ì„±ê³µì‹œ ì„œë²„ì— ì£¼ë¬¸ + ê²€ì¦ ìš”ì²­
                fetch("/api/payments/verify", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        imp_uid: rsp.imp_uid,
                        merchant_uid: rsp.merchant_uid,
                        memberId: memberId,
                        itemId: bookId,
                        count: count
                    })
                }).then(res => res.json())
                    .then(data => {
                        alert("ê²°ì œ ë° ì£¼ë¬¸ ì™„ë£Œ: " + JSON.stringify(data));
                        window.location.href = "/orders";
                    });
            } else {
                alert("ê²°ì œ ì‹¤íŒ¨: " + rsp.error_msg);
            }
        });
    }
</script>-->

<!--<script th:inline="javascript">
    function waitPortOneLoaded() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (window.PortOne) {
                    clearInterval(check);
                    resolve();
                }
            }, 100);
        });
    }

    window.requestPay = async function () {
        await waitPortOneLoaded();

        function randomId() {
            return [...crypto.getRandomValues(new Uint32Array(2))]
                .map((word) => word.toString(16).padStart(8, "0"))
                .join("");
        }

        const paymentId = randomId();

        const payment = await PortOne.requestPayment({
            storeId: "iamporttest_3",
            channelKey: "channel-key-4ea5e726-aaab-43e4-a936-1ea0c68bfa69",
            paymentId: paymentId,
            orderName: "[[${book.name}]]",
            totalAmount: [[${book.price}]],
            currency: "KRW",
            payMethod: "CARD",
            customData: {
                itemId: [[${book.id}]],
                memberId: [[${loginMember.id}]],
                count: document.querySelector("input[name='count']").value
            }
        });

        if (payment.code !== undefined) {
            alert("ê²°ì œ ì‹¤íŒ¨: " + payment.message);
            return;
        }

        const response = await fetch("/api/payment/complete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId: payment.paymentId })
        });

        const result = await response.json();
        alert("ê²°ì œ ì™„ë£Œ: " + JSON.stringify(result));
        location.href = "/orders";
    };
</script>-->

<!-- í¬íŠ¸ì› ê²°ì œ íê¸°

&lt;!&ndash;ë³€ìˆ˜ ë¨¼ì € í• ë‹¹&ndash;&gt;
<script th:inline="javascript">
    const bookId = [[${book.id}]];
    const memberId = [[${loginMember.id}]];
    const bookName = [[${book.name}]];
    const bookPrice = [[${book.price}]];
</script>

&lt;!&ndash;v2 ë²„ì „ í•´ë³´ê¸°&ndash;&gt;
<script th:inline="javascript">
    // PortOne ë¡œë”© ëŒ€ê¸°
    function waitPortOneLoaded() {
        return new Promise((resolve) => {
            const check = setInterval(() => {
                if (window.PortOne) {
                    clearInterval(check);
                    resolve();
                }
            }, 100);
        });
    }

    // ì „ì—­ì— ê²°ì œ í•¨ìˆ˜ ë“±ë¡
    window.requestPay = async function () {

        await waitPortOneLoaded();

        function randomId() {
            return [...crypto.getRandomValues(new Uint32Array(2))]
                .map((word) => word.toString(16).padStart(8, "0"))
                .join("");
        }

        const count = document.querySelector("input[name='count']").value;
        const paymentId = randomId();

        const payment = await PortOne.requestPayment({
            storeId: "store-5290c2f9-b27d-4bf3-a88a-48717e658e5e", // ì˜ˆ: iamporttest_3
            channelKey: "channel-key-4ea5e726-aaab-43e4-a936-1ea0c68bfa69", // ì˜ˆ: channel-key-xxxx...
            paymentId: paymentId,
            orderName: bookName,
            totalAmount: bookPrice * count,
            currency: "KRW",
            payMethod: "CARD",
            // redirectUrl: "https://8e0b6d606c26.ngrok-free.app/payment/success",
            customData: {
                itemId: bookId,
                memberId: memberId,
                count: count
            }
        });

        // âœ… ì‘ë‹µ ë¬´ì¡°ê±´ ë¡œê·¸ ì¶œë ¥
        console.log("ğŸ“¦ PortOne ì‘ë‹µ ì „ì²´ â†“â†“â†“");
        console.log(payment);

        if (payment.code !== undefined) {
            alert("ê²°ì œ ì‹¤íŒ¨: " + payment.message);
            return;
        }
// ğŸš¨ ë””ë²„ê¹…ì„ ìœ„í•œ ì¶”ê°€ ë¡œê·¸: ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„° í™•ì¸
        const dataToSend = {
            paymentId: payment.paymentId, // <&#45;&#45; ì´ ë¶€ë¶„ì´ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
            itemId: bookId,
            memberId: memberId,
            count: count
        };
        console.log("ğŸ‘‰ ì„œë²„ë¡œ ì „ì†¡í•  í˜ì´ë¡œë“œ:", JSON.stringify(dataToSend)); // ì „ì†¡ë  JSON ë¬¸ìì—´ í™•ì¸

        //ê²°ì œ ì„±ê³µí›„ ì„œë²„ì— ê²°ì œ ì™„ë£Œ ë° ì£¼ë¬¸ ìƒì„± ìš”ì²­
        try {
            const response = await fetch("/api/payment/complete", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    paymentId: payment.paymentId,
                    itemId: bookId,
                    memberId: memberId,
                    count: count
                })
            });
            const result = await response.json();
            alert("ê²°ì œ ë° ì£¼ë¬¸ ì„±ê³µ! ì£¼ë¬¸ ID: " + result.orderId);
            location.href = "/orders";
        } catch (err) {
            alert("ì„œë²„ ìš”ì²­ ì‹¤íŒ¨: " + err);
        }
    };
</script>
-->